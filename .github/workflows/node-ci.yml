name: Reusable Node.js CI
# Complete CI workflow for Node.js projects supporting both bun and pnpm
# Runs: setup â†’ lint â†’ typecheck â†’ test â†’ build â†’ audit
# Uploads coverage and build artifacts

on:
  workflow_call:
    inputs:
      package-manager:
        description: 'Package manager to use (bun or pnpm)'
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout commit
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ“„ Read .nvmrc if exists
        id: nvm
        run: |
          if [ -f .nvmrc ]; then
            echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_OUTPUT
          else
            echo "NODE_VERSION=24" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”§ Setup Node.js
        if: inputs.package-manager == 'pnpm'
        uses: actions/setup-node@v6
        with:
          node-version: ${{ steps.nvm.outputs.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Setup pnpm
        if: inputs.package-manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: ğŸ Setup bun
        if: inputs.package-manager == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ğŸ“¦ Install dependencies
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm install --frozen-lockfile
          else
            bun install --frozen-lockfile
          fi

      - name: Check available scripts
        id: scripts
        run: |
          node -e "
          const fs = require('fs');
          try {
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            const scripts = pkg.scripts || {};
            ['lint', 'format:check', 'typecheck', 'test', 'build', 'jscpd', 'knip', 'audit'].forEach(s => {
              const outputName = s.replace(/:/g, '_');
              console.log(outputName + '=' + (scripts[s] ? 'true' : 'false'));
            });
          } catch (e) {
            ['lint', 'format:check', 'typecheck', 'test', 'build', 'jscpd', 'knip', 'audit'].forEach(s => {
              const outputName = s.replace(/:/g, '_');
              console.log(outputName + '=false');
            });
          }
          " >> $GITHUB_OUTPUT
          echo "has_src_lib=$([ -d src ] || [ -d lib ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      - name: ğŸ” Run lint
        if: steps.scripts.outputs.lint == 'true'
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm lint
          else
            bun run lint
          fi

      - name: âœ… Check formatting
        if: steps.scripts.outputs.format_check == 'true'
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm format:check
          else
            bun run format:check
          fi
      - name: ğŸ” Run typecheck
        if: steps.scripts.outputs.typecheck == 'true'
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm typecheck
          else
            bun run typecheck
          fi

      - name: ğŸ§ª Run tests
        if: steps.scripts.outputs.test == 'true'
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm test --coverage
          else
            bun test --coverage
          fi

      - name: ğŸ“Š Upload coverage reports
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ inputs.package-manager }}
          path: |
            coverage/
            *.coverage
            .coverage
          retention-days: 7

      - name: ğŸ—ï¸ Run build
        if: steps.scripts.outputs.build == 'true'
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm build
          else
            bun run build
          fi

      - name: ğŸ“¤ Upload build artifacts
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ inputs.package-manager }}
          path: |
            dist/
            build/
            .next/
            out/
          retention-days: 7

      - name: ğŸ” Check for duplicate code
        if: steps.scripts.outputs.jscpd == 'true'
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm jscpd
          else
            bun jscpd
          fi

      - name: âœ… Run Knip
        if: steps.scripts.outputs.knip == 'true'
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm knip
          else
            bun knip
          fi

      - name: ğŸ”’ Run security audit
        if: steps.scripts.outputs.audit == 'true'
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm audit --audit-level=moderate
          else
            bun audit --moderate
          fi
