name: Reusable Node.js CI

on:
  workflow_call:
    inputs:
      package-manager:
        description: 'Package manager to use (bun or pnpm)'
        default: 'bun'
        type: string
      upload-coverage:
        description: 'Whether to upload coverage reports'
        default: false
        type: boolean
      skip-build:
        description: 'Whether to skip the build step'
        default: true
        type: boolean
      node-version:
        description: 'Node.js version to use'
        default: '24'
        type: string
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout commit
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ”¤ Spell Check with Typos
        uses: crate-ci/typos@v1.43.5

      - name: ğŸ“„ Read .nvmrc if exists
        id: nvm
        run: |
          if [ -f .nvmrc ]; then
            echo "NODE_VERSION=$(cat .nvmrc)" >> "$GITHUB_OUTPUT"
          else
            echo "NODE_VERSION=${{ inputs.node-version }}" >> "$GITHUB_OUTPUT"
          fi

      - name: ğŸ“¦ Setup dependencies with cache
        uses: victory-sokolov/githooks/.github/actions/node-deps-cache@main
        with:
          package-manager: ${{ inputs.package-manager }}
          node-version: ${{ steps.nvm.outputs.NODE_VERSION }}

      - name: Check available scripts
        id: scripts
        run: |
          node -e "
          const fs = require('fs');
          try {
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            const scripts = pkg.scripts || {};
            ['lint', 'format:check', 'typecheck', 'test', 'build', 'jscpd', 'knip', 'audit'].forEach(s => {
              const outputName = s.replace(/:/g, '_');
              console.log(outputName + '=' + (scripts[s] ? 'true' : 'false'));
            });
          } catch (e) {
            ['lint', 'format:check', 'typecheck', 'test', 'build', 'jscpd', 'knip', 'audit'].forEach(s => {
              const outputName = s.replace(/:/g, '_');
              console.log(outputName + '=false');
            });
          }
          " >> "$GITHUB_OUTPUT"
          echo "has_src_lib=$([ -d src ] || [ -d lib ] && echo 'true' || echo 'false')" >> "$GITHUB_OUTPUT"

      - name: ğŸ” Run lint
        if: steps.scripts.outputs.lint == 'true'
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm lint
          else
            bun run lint
          fi

      - name: âœ… Check formatting
        if: steps.scripts.outputs.format_check == 'true'
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm format:check
          else
            bun run format:check
          fi
      - name: ğŸ” Run typecheck
        if: steps.scripts.outputs.typecheck == 'true'
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm typecheck
          else
            bun run typecheck
          fi

      - name: ğŸ”¨ Run build
        if: steps.scripts.outputs.build == 'true' && !inputs.skip-build
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm build
          else
            bun run build
          fi

      - uses: reviewdog/action-setup@d8edfce3dd5e1ec6978745e801f9c50b5ef80252 # v1.4.0
        with:
          reviewdog_version: latest

      - name: ğŸ§ª Run tests
        if: steps.scripts.outputs.test == 'true'
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm test --coverage
          else
            bun test --coverage
          fi

      - name: ğŸ“Š Upload coverage reports
        if: inputs.upload-coverage && (success() || failure())
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report-${{ inputs.package-manager }}
          path: |
            coverage/
            *.coverage
            .coverage
          retention-days: 7
          compression-level: 6

      - name: ğŸ” Check for duplicate code
        if: steps.scripts.outputs.jscpd == 'true'
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm jscpd
          else
            bun jscpd
          fi

      - name: âœ… Run Knip
        if: steps.scripts.outputs.knip == 'true'
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm knip --cache
          else
            bun knip --cache
          fi

      - name: ğŸ”’ Run security audit
        if: steps.scripts.outputs.audit == 'true'
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm audit --audit-level=moderate
          else
            bun audit --moderate
          fi
