name: Reusable Python CI

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        default: '3.14'
        type: string
      uv-version:
        description: 'uv version to use'
        default: 'latest'
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout commit
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ”¤ Spell Check with Typos
        uses: crate-ci/typos@v1.43.5

      - name: ğŸ“„ Read .python-version if exists
        id: python-version
        run: |
          if [ -f .python-version ]; then
            echo "PYTHON_VERSION=$(cat .python-version)" >> "$GITHUB_OUTPUT"
          else
            echo "PYTHON_VERSION=${{ inputs.python-version }}" >> "$GITHUB_OUTPUT"
          fi

      - name: ğŸ Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ steps.python-version.outputs.PYTHON }}

      - name: ğŸš€ Install uv
        uses: astral-sh/setup-uv@v7.3
        with:
          version: ${{ inputs.uv-version }}

      - name: ğŸ“¦ Setup UV cache
        uses: actions/cache@v5
        with:
          path: |
            .uv-cache
            ~/.cache/uv
          key: uv-${{ runner.os }}-${{ steps.python-version.outputs.PYTHON }}-${{ hashFiles('uv.lock', 'pyproject.toml', 'requirements*.txt') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ steps.python-version.outputs.PYTHON }}-
            uv-${{ runner.os }}-

      - name: ğŸ“¥ Install dependencies
        run: |
          if [ -f uv.lock ]; then
            uv sync
          elif [ -f pyproject.toml ]; then
            uv sync --no-dev
          elif [ -f requirements.txt ]; then
            uv pip install -r requirements.txt
          fi

      - name: ğŸ” Run ruff linter
        run: uv run ruff check .
        continue-on-error: true

      - name: âœ… Run ruff formatter check
        run: uv run ruff format --check .

      - uses: reviewdog/action-setup@d8edfce3dd5e1ec6978745e801f9c50b5ef80252 # v1.4.0
        with:
          reviewdog_version: latest

      - name: ğŸ§ª Run tests with pytest
        run: uv run pytest --cov=. --cov-report=xml --cov-report=html
        continue-on-error: true

      - name: ğŸ“Š Upload coverage to Codecov
        if: success()
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: ğŸ“¤ Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/
            .coverage
          retention-days: 7
          compression-level: 6
