name: nextjs

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: false
        default: 'lts'
        type: string
      working-directory:
        description: 'Working directory for the Next.js app'
        required: false
        default: '.'
        type: string
      package-manager:
        description: 'Package manager to use (npm, pnpm, or bun)'
        required: false
        default: 'npm'
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-and-export:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Read .nvmrc if exists
        id: nvm
        run: |
          if [ -f .nvmrc ]; then
            echo "NODE_VERSION=$(cat .nvmrc)" >> "$GITHUB_OUTPUT"
          else
            echo "NODE_VERSION=${{ inputs.node-version }}" >> "$GITHUB_OUTPUT"
          fi

      - name: ðŸ“¦ Setup dependencies with cache
        uses: victory-sokolov/githooks/.github/actions/node-deps-cache@main
        with:
          package-manager: "${{ inputs.package-manager }}"
          node-version: "${{ steps.nvm.outputs.NODE_VERSION }}"
          working-directory: "${{ inputs.working-directory }}"

      - name: Cache Next.js build outputs
        uses: actions/cache@v4
        with:
          path: ${{ inputs.working-directory }}/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles(format('{0}/package-lock.json', inputs.working-directory), format('{0}/pnpm-lock.yaml', inputs.working-directory), format('{0}/bun.lockb', inputs.working-directory)) }}
          restore-keys: |
            ${{ runner.os }}-nextjs-

      - name: Build Next.js app
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm run build
          elif [ "${{ inputs.package-manager }}" == "bun" ]; then
            bun run build
          else
            npm run build
          fi

      - name: Run tests
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm test
          elif [ "${{ inputs.package-manager }}" == "bun" ]; then
            bun test
          else
            npm test
          fi
        continue-on-error: true # Allow workflow to continue if tests fail

      - name: Export Next.js app
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm run export
          elif [ "${{ inputs.package-manager }}" == "bun" ]; then
            bun run export
          else
            npm run export
          fi
        # Note: 'next export' is deprecated in Next.js 13+. For static export, configure output: 'export' in next.config.js and use 'next build' instead.

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: nextjs-build
          path: ${{ inputs.working-directory }}/out/
          retention-days: 30
