name: Reusable Node.js CI
# Complete CI workflow for Node.js projects supporting both bun and pnpm
# Runs: setup â†’ lint â†’ typecheck â†’ test â†’ build â†’ audit
# Uploads coverage and build artifacts

on:
  workflow_call:
    inputs:
      package-manager:
        description: 'Package manager to use (bun or pnpm)'
        required: true
        type: string

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout commit
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ“„ Read .nvmrc if exists
        id: nvm
        run: |
          if [ -f .nvmrc ]; then
            echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_OUTPUT
          else
            echo "NODE_VERSION=24" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”§ Setup Node.js
        if: inputs.package-manager == 'pnpm'
        uses: actions/setup-node@v6
        with:
          node-version: ${{ steps.nvm.outputs.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Setup pnpm
        if: inputs.package-manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: ğŸ Setup bun
        if: inputs.package-manager == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ğŸ“¦ Install dependencies
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm install --frozen-lockfile
          else
            bun install --frozen-lockfile
          fi

      - name: ğŸ” Run lint
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm lint
          else
            bun run lint
          fi

      - name: âœ… Check formatting
        if: inputs.package-manager == 'pnpm'
        run: pnpm format:check

      - name: âœ… Run Knip
        if: inputs.package-manager == 'pnpm'
        run: pnpm knip

      - name: ğŸ” Run typecheck
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm typecheck
          else
            bun run typecheck
          fi

      - name: ğŸ§ª Run tests
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm test --coverage
          else
            bun test --coverage
          fi

      - name: ğŸ“Š Upload coverage reports
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ inputs.package-manager }}
          path: |
            coverage/
            *.coverage
            .coverage
          retention-days: 7

      - name: ğŸ—ï¸ Run build
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm build
          else
            bun run build
          fi

      - name: ğŸ“¤ Upload build artifacts
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ inputs.package-manager }}
          path: |
            dist/
            build/
            .next/
            out/
          retention-days: 7

      - name: ğŸ” Check for duplicate code
        if: inputs.package-manager == 'bun'
        run: bunx jscpd src/ lib/

      - name: ğŸ”’ Run security audit
        run: |
          if [ "${{ inputs.package-manager }}" == "pnpm" ]; then
            pnpm audit --audit-level=moderate
          else
            bun pm audit --moderate
          fi